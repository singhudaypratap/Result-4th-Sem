<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PIET — Result Lookup</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
      :root{ --brand:#0d6efd; --muted:#6b7280; }
      body{ font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%); }
      .app-shell{ min-height:100vh; display:flex; flex-direction:column; }
      .container-card{ max-width:980px; margin:48px auto; }
      .card { border-radius:14px; box-shadow:0 10px 30px rgba(16,24,40,0.08); overflow:hidden; }
      .card-header{ background:linear-gradient(90deg, rgba(13,110,253,0.12), rgba(99,102,241,0.06)); padding:20px 24px; display:flex; align-items:center; gap:16px; }
      .logo-wrap{ width:64px; height:64px; border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
      .brand-title{ font-weight:700; font-size:18px; }
      .brand-sub{ color:var(--muted); font-size:13px; }

      .form-section{ padding:20px 24px; display:grid; grid-template-columns: 1fr 320px; gap:20px; align-items:start; }
      .controls{ background:#fff; padding:18px; border-radius:10px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
      .result-area{ background:linear-gradient(180deg,#fff, #fbfdff); padding:18px; border-radius:10px; }

      .hint{ font-size:13px; color:var(--muted); }
      table.result-table td, table.result-table th{ vertical-align:middle; }

      .footer{ margin-top:auto; padding:18px; text-align:center; font-size:13px; color:var(--muted); }
      .dept{ font-weight:600; color:#0f172a; }

      @media(max-width:880px){ .form-section{ grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="container container-card">
        <div class="card">
          <div class="card-header">
            <div class="logo-wrap">
              <!-- Replace with your logo file in production -->
              <img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png" alt="PIET" width="48" height="48" style="border-radius:8px;">
            </div>
            <div>
              <div class="brand-title">PIET — Result Lookup</div>
              <div class="brand-sub">Enter registration number and select branch to view results</div>
            </div>
            <div class="ms-auto text-end">
              <div class="badge bg-light text-dark">B.Tech IV Sem — 2024-25</div>
            </div>
          </div>

          <div class="form-section">
            <div class="controls">
              <form id="lookupForm" class="row g-3">
                <div class="col-12">
                  <label for="reg" class="form-label small">Registration Number</label>
                  <input type="text" class="form-control form-control-lg" id="reg" name="reg" placeholder="e.g. PIET23AD001" required>
                </div>

                <div class="col-12">
                  <label for="branch" class="form-label small">Branch</label>
                  <select id="branch" name="branch" class="form-select" required>
                    <option value="CS">CS</option>
                    <option value="CSR-D">CSR-D</option>
                    <option value="AI&DS-E">AI&amp;DS-E</option>
                    <option value="CS(AI)-F">CS(AI)-F</option>
                    <option value="CS(DS)-G">CS(DS)-G</option>
                    <option value="CS(IOT)-H">CS(IOT)-H</option>
                  </select>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-lg" id="btnLookup">
                    <span id="btnText">Get Result</span>
                    <span id="btnSpinner" class="visually-hidden ms-2"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></span>
                  </button>
                  <button type="button" id="btnClear" class="btn btn-outline-secondary btn-lg">Clear</button>
                  <div class="ms-auto align-self-center hint">Tip: use uppercase reg. no. for exact match</div>
                </div>

                <div class="col-12">
                  <div id="messageArea" class="mt-2"></div>
                </div>
              </form>

              <hr>
              <div class="hint">Quick actions: <button id="downloadCSV" class="btn btn-sm btn-link">Download CSV</button> • <button id="printBtn" class="btn btn-sm btn-link">Print Result</button></div>
            </div>

            <div class="result-area" id="resultArea">
              <div class="text-center py-5">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png" alt="placeholder" width="96" class="mb-3" style="opacity:0.85; border-radius:8px;">
                <div class="h5">No query yet</div>
                <div class="hint">Enter registration number and click <strong>Get Result</strong> to display student marks in a table.</div>
              </div>
            </div>
          </div>

        </div>

        <div class="footer">
          <div>Developed by <span class="dept">Department of AI &amp; DS, PIET Jaipur</span></div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const form = document.getElementById('lookupForm');
      const resultArea = document.getElementById('resultArea');
      const btnLookup = document.getElementById('btnLookup');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      const btnClear = document.getElementById('btnClear');
      const messageArea = document.getElementById('messageArea');

      function setLoading(on=true){
        if(on){
          btnText.innerText = 'Searching...';
          btnSpinner.classList.remove('visually-hidden');
          btnLookup.disabled = true;
        } else {
          btnText.innerText = 'Get Result';
          btnSpinner.classList.add('visually-hidden');
          btnLookup.disabled = false;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageArea.innerHTML = '';
        const formData = new FormData(form);
        const reg = formData.get('reg')?.trim();
        const branch = formData.get('branch');
        if(!reg){
          messageArea.innerHTML = '<div class="alert alert-warning">Please enter registration number.</div>';
          return;
        }

        setLoading(true);
        try{
          const resp = await fetch('/', { method: 'POST', body: formData });
          const html = await resp.text();

          // Extract body content if full page returned
          const bodyStart = html.indexOf('<body');
          const bodyEnd = html.lastIndexOf('</body>');
          let snippet = html;
          if(bodyStart !== -1 && bodyEnd !== -1){
            const startTagClose = html.indexOf('>', bodyStart);
            if(startTagClose !== -1 && startTagClose < bodyEnd){
              snippet = html.substring(startTagClose+1, bodyEnd);
            }
          }

          resultArea.innerHTML = snippet || '<div class="alert alert-info">No content returned.</div>';

          // Optional: scroll to result
          resultArea.scrollIntoView({behavior:'smooth'});

        } catch(err){
          console.error(err);
          resultArea.innerHTML = `<div class="alert alert-danger">Request failed: ${err.message}</div>`;
        } finally{
          setLoading(false);
        }
      });

      btnClear.addEventListener('click', () => {
        form.reset();
        resultArea.innerHTML = '<div class="text-center py-5"><div class="h5">Cleared</div><div class="hint">Enter new query.</div></div>';
        messageArea.innerHTML = '';
      });

      // Print
      document.getElementById('printBtn').addEventListener('click', () => window.print());

      // Download CSV: tries to take table data if exists
      document.getElementById('downloadCSV').addEventListener('click', () => {
        const table = resultArea.querySelector('table');
        if(!table){ alert('No result table to download.'); return; }

        const rows = Array.from(table.querySelectorAll('tr'));
        const csv = rows.map(r => Array.from(r.querySelectorAll('th,td')).map(c => '"'+c.innerText.replace(/"/g,'""')+'"').join(',')).join('
');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'result.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
